services:
  kafka:
    image: confluentinc/cp-kafka:7.7.0
    hostname: kafka
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,HOST:PLAINTEXT"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:29092,HOST://localhost:9092"
      KAFKA_LISTENERS: "PLAINTEXT://0.0.0.0:29092,CONTROLLER://0.0.0.0:29093,HOST://0.0.0.0:9092"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_INTER_BROKER_LISTENER_NAME: "PLAINTEXT"
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@kafka:29093"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      CLUSTER_ID: "MkU3OEVBNTcwNTJENDM2Qk"
    healthcheck:
      test: [ "CMD-SHELL", "kafka-topics --bootstrap-server localhost:9092 --list" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686" # Jaeger UI
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP

  loki:
    image: grafana/loki:latest
    container_name: loki
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml

  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./promtail-config.yml:/etc/promtail/config.yml
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki

  prometheus:
    image: prom/prometheus:v2.53.0
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    depends_on:
      - monitoring-api

  grafana:
    image: grafana/grafana:latest
    container_name: monitoring-grafana
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=yesoreyeram-infinity-datasource
    depends_on:
      - prometheus
      - jaeger
      - loki
      - monitoring-api

  monitoring-api:
    build:
      context: ..
      dockerfile: toy_project/monitoring_service/Dockerfile
    container_name: monitoring-api
    ports:
      - "8000:8000"
    environment:
      DATABASE_PATH: /data/transactions.db
      DB_RESET_ON_START: "true"
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_TOPIC: transactions
      KAFKA_GROUP_ID: monitoring-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
      ALERT_WEBHOOK_URL: https://webhook.site/676cbac0-a68a-4d0f-9c2f-3f294430b9c6
    volumes:
      - api-data:/data
    depends_on:
      kafka:
        condition: service_healthy
      jaeger:
        condition: service_started

  stream-processor:
    build:
      context: ..
      dockerfile: toy_project/stream_processor/Dockerfile
    container_name: stream-processor
    ports:
      - "8001:8001"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      KAFKA_TOPIC: transactions
      CSV_PATH: /data/sample_data/transactions/transactions.csv
      STREAM_DELAY: "0.1"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
    stdin_open: true
    tty: true
    volumes:
      - ../sample_data:/data/sample_data:ro
    depends_on:
      kafka:
        condition: service_healthy
      jaeger:
        condition: service_started
      monitoring-api:
        condition: service_started

volumes:
  api-data:
